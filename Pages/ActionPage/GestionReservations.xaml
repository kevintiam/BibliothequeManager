<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="BibliothequeManager.Pages.ActionPage.GestionReservations"
             xmlns:localApp="clr-namespace:BibliothequeManager"
             Title="Gestion des Réservations"
             NavigationPage.HasNavigationBar="False"
             BackgroundColor="#F8FAFC">
    <Grid>
        <!-- Fond avec dégradé -->
        <Image Source="new_background.png"
           Aspect="AspectFill"
           InputTransparent="True"
           Opacity="0.2" />

        <ScrollView>
            <Grid RowDefinitions="Auto, Auto, *">


                <!-- En-tête -->
                <Grid Style="{StaticResource StackLayoutAcc}">
                    <StackLayout Orientation="Horizontal" HorizontalOptions="Center" Spacing="100">
                        <!-- Logo à gauche -->
                        <Border Style="{StaticResource RoundedImageBorder}">
                            <Image Source="logo.png" Style="{StaticResource Logo}" />
                        </Border>

                        <StackLayout VerticalOptions="Center">
                            <Label Text="{Binding [ManageReservations], Source={x:Static localApp:App.Localized}}" 
                                    Style="{StaticResource HeaderLabel}"/>
                            <Label Text="{Binding [PendingReservations], Source={x:Static localApp:App.Localized}}" 
                                    Style="{StaticResource SubHeaderLabel}"/>
                        </StackLayout>
                    </StackLayout>
                </Grid>

                <!-- Barre d'outils et statistiques -->
                <Border Grid.Row="1" 
                       Style="{StaticResource ModernCard}">
                    <StackLayout Spacing="15">

                        <!-- Barre de recherche et filtres -->
                        <Grid ColumnDefinitions="Auto, *, Auto, Auto" 
                              ColumnSpacing="10">
                            <Button Grid.Column="0" 
                                    Text="{Binding [Home], Source={x:Static localApp:App.Localized}}" 
                                    Style="{StaticResource GradientButtonSecondary}"
                                    Clicked="OnAccueilClicked"/>
                            <Entry x:Name="SearchEntry"
                                    Placeholder="{Binding [SearchReservations], Source={x:Static localApp:App.Localized}}" 
                                    Style="{StaticResource ModernEntry}"
                                    Grid.Column="1"/>
                            <Picker x:Name="StatutPicker"
                                    Title="{Binding [Status], Source={x:Static localApp:App.Localized}}"
                                    Style="{StaticResource ModernPicker}"
                                    Grid.Column="2"
                                    WidthRequest="140" 
                                    SelectedIndexChanged="StatutPicker_SelectedIndexChanged"/>

                            <Button Grid.Column="3"
                                     Text="{Binding [New], Source={x:Static localApp:App.Localized}}"
                                     Style="{StaticResource GradientButtonPrimary}"
                                    Clicked="OnNewReservation"/>
                        </Grid>

                        <!-- Statistiques rapides -->
                        <Border Style="{StaticResource BorderLivreSelectionne}"
                                Margin="10">
                            <Grid ColumnDefinitions="*, *, *, *, *" 
                                   ColumnSpacing="10"
                                   Padding="15">

                                <StackLayout Grid.Column="0" Spacing="5" HorizontalOptions="Center">
                                    <Label x:Name="TotalReservations"
                                            FontFamily="PlaypenSansBold"
                                            FontSize="20"
                                            TextColor="#1E293B"
                                            HorizontalOptions="Center"/>
                                    <Label Text="{Binding [All], Source={x:Static localApp:App.Localized}}"
                                        Style="{StaticResource LabelEmprunt}"/>
                                </StackLayout>

                                <StackLayout Grid.Column="1" Spacing="5" HorizontalOptions="Center">
                                    <Label  x:Name="ReservationsEnAttente" 
                                            FontFamily="PlaypenSansBold"
                                            FontSize="20"
                                            TextColor="#F59E0B"
                                            HorizontalOptions="Center"/>
                                    <Label Text="{Binding [Pending], Source={x:Static localApp:App.Localized}}"
                                        Style="{StaticResource LabelEmprunt}"/>
                                </StackLayout>

                                <StackLayout Grid.Column="2" Spacing="5" HorizontalOptions="Center">
                                    <Label x:Name="ReservationsConfirmees" 
                                        FontFamily="PlaypenSansBold"
                                        FontSize="20"
                                        TextColor="#10B981"
                                        HorizontalOptions="Center"/>
                                    <Label Text="{Binding [Confirmed], Source={x:Static localApp:App.Localized}}"
                                        Style="{StaticResource LabelEmprunt}"/>
                                </StackLayout>
                                
                                <StackLayout Grid.Column="3" Spacing="5" HorizontalOptions="Center">
                                    <Label x:Name="ReservationsEnCours" 
                                            FontFamily="PlaypenSansBold"
                                            FontSize="20"
                                            TextColor="#3B82F6"
                                            HorizontalOptions="Center"/>
                                    <Label Text="{Binding [InProgress], Source={x:Static localApp:App.Localized}}"
                                            Style="{StaticResource LabelEmprunt}"/>
                                </StackLayout>

                                <StackLayout Grid.Column="4" Spacing="5" HorizontalOptions="Center">
                                    <Label x:Name="ReservationsExpirees" 
                                            FontFamily="PlaypenSansBold"
                                            FontSize="20"
                                            TextColor="#EF4444"
                                            HorizontalOptions="Center"/>
                                    <Label Text="{Binding [Expired], Source={x:Static localApp:App.Localized}}"
                                            Style="{StaticResource LabelEmprunt}"/>
                                </StackLayout>
                            </Grid>
                        </Border>
                    </StackLayout>
                </Border>

                <!-- Liste des réservations -->
                <Border Grid.Row="2" Style="{StaticResource ModernCard}" >
                    <Grid RowDefinitions="Auto, *">

                        <!-- En-tête du tableau -->
                        <Border Grid.Row="0" 
                                BackgroundColor="#F1F5F9"
                                Padding="15,12">
                            <Grid ColumnDefinitions="1.5*,1*,1*,1*,1*,1.2*"
                                   ColumnSpacing="10">
                                <Label Text="{Binding [BookAndMember], Source={x:Static localApp:App.Localized}}" Style="{StaticResource TableHeader}" />
                                <Label Text="{Binding [ReservationDate], Source={x:Static localApp:App.Localized}}" Style="{StaticResource TableHeader}" Grid.Column="1"/>
                                <Label Text="{Binding [StartDate], Source={x:Static localApp:App.Localized}}" Style="{StaticResource TableHeader}" Grid.Column="2"/>
                                <Label Text="{Binding [DaysRemaining], Source={x:Static localApp:App.Localized}}" Style="{StaticResource TableHeader}" Grid.Column="3"/>
                                <Label Text="{Binding [Priority], Source={x:Static localApp:App.Localized}}" Style="{StaticResource TableHeader}" Grid.Column="4"/>
                                <Label Text="{Binding [Actions], Source={x:Static localApp:App.Localized}}" Style="{StaticResource TableHeader}" Grid.Column="5" HorizontalTextAlignment="Center"/>
                            </Grid>
                        </Border>

                        <!-- Liste -->
                        <CollectionView 
                            x:Name="CollectionViewReservations"
                            Grid.Row="1"
                             ItemsSource="{Binding Reservations}"
                             SelectionMode="Single"
                             EmptyView="Aucune réservation trouvée">

                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Style="{StaticResource TabContent}">
                                        <Grid ColumnDefinitions="1.5*,1*,1*,1*,1*,1.2*" 
                                            Padding="15,12"
                                            ColumnSpacing="10">

                                            <!-- Colonne Livre & Adhérent -->
                                            <StackLayout Grid.Column="0" Spacing="4">
                                                <Label Text="{Binding Livre.Titre}" Style="{StaticResource TableRowData}" FontSize="15" TextColor="Blue" FontAttributes="Bold"/>
                                                <Label Text="{Binding Adherent.Nom}" Style="{StaticResource TableRowData}" FontSize="14" TextColor="Chocolate"/>
                                                <Label Text="{Binding Adherent.Email}" Style="{StaticResource TableRowData}"/>
                                            </StackLayout>

                                            <!-- Date Réservation -->
                                            <Label Grid.Column="1"  Text="{Binding DateReservation, StringFormat='{0:dd/MM/yy}'}" Style="{StaticResource TableRowData}"/>

                                            <!-- Date Début -->
                                            <Label Grid.Column="2" Text="{Binding DateRecuperationPrevue, StringFormat='{0:dd/MM/yy}'}" Style="{StaticResource TableRowData}"/>

                                                    <!-- Jours restants -->
                                            <Label Grid.Column="3" Text="{Binding JoursRestants}" Style="{StaticResource TableRowData}"/>

                                            <!-- Priorité et Statut -->
                                            <StackLayout Grid.Column="4" Spacing="2">
                                                <Label Text="{Binding Statut}" Style="{StaticResource TableRowData}"/>
                                                <Label Text="{Binding Priorite}" Style="{StaticResource TableRowData}"/>
                                            </StackLayout>

                                            <!-- Actions -->
                                            <StackLayout Grid.Column="6" 
                                              Orientation="Horizontal" 
                                              Spacing="5"
                                              HorizontalOptions="Center">

                                                <Button Text="✓"
                                             BackgroundColor="#10B981"
                                             TextColor="White"
                                             FontSize="10"
                                             CornerRadius="6"
                                             WidthRequest="28"
                                             HeightRequest="28"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Valider}"
                                            CommandParameter="{Binding .}"/>

                                                <Button Text="✎"
                                             BackgroundColor="#F59E0B"
                                             TextColor="White"
                                             FontSize="10"
                                             CornerRadius="6"
                                             WidthRequest="28"
                                             HeightRequest="28"
                                             Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.Modifier}"
                                            CommandParameter="{Binding .}"/>
                                            </StackLayout>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Grid>
                </Border>
            </Grid>
        </ScrollView>
    </Grid>
</ContentPage>